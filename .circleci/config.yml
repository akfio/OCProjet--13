version: 2.1
orbs:
  python: circleci/python@1.2
  docker: circleci/docker@1.7.0

jobs:
  build-and-test:
    docker:
      - image: cimg/python:3.8
    steps:
      - checkout
      - python/install-packages:
          pkg-manager: pip
      - run:
          name: Run tests
          command: pytest


  build-push-image-DockerHub:
    executor: docker/docker
    steps:
      - checkout
      - setup_remote_docker
      - docker/build:
          - name: akfio/oc-lettings-8
          - extra_build_args: '-t akfio/oc-lettings-8'
      - docker/push:
          image: akfio/oc-lettings-8
          tag: "latest"


  deploy-to-Heroku:
    machine: true
    steps:
      - checkout
      - run:
          name: Build and push Docker image to Heroku
          command: |
            sudo curl https://cli-assets.heroku.com/install.sh | sh
            HEROKU_API_KEY=${HEROKU_TOKEN} heroku container:login
            HEROKU_API_KEY=${HEROKU_TOKEN} heroku container:push web -a oc-lettings-8
            HEROKU_API_KEY=${HEROKU_TOKEN} heroku container:release web -a=oc-lettings-8


workflows:
  workflow:
    jobs:
      - build-and-test
      - build-push-image-DockerHub:
            requires:
                - build-and-test
            filters:
              branches:
                only: master
      - deploy-to-Heroku:
            requires:
              - build-push-image-DockerHub
            filters:
              branches:
                only: master